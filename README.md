# ChinaMeth: Comprehensive DNA Methylation Analysis for Diverse Population

![Version](https://img.shields.io/badge/version-1.0.0-blue)
![Language](https://img.shields.io/badge/language-R-blue)
![Language](https://img.shields.io/badge/language-shell-4EAA25)
![Language](https://img.shields.io/badge/language-python-blue)
![License](https://img.shields.io/badge/license-MIT-green)
![Platform](https://img.shields.io/badge/platform-linux%20|%20macOS-brightgreen)

<div align="left">
    <img src="images/ChinaMeth.png" alt="ChinaMeth" width="300"/>
</div>

- [ChinaMeth profile](#chinameth-profile)
- [Technological advances](#technological-advances)
- [Breakgthrough findings](#breakgthrough-findings)
- [Benefits for Future Researchers](#benefits-for-future-researchers)
- [Analysis Workflow](#analysis-workflow)
    - [Methylation workflow](#methylation-workflow)
    - [Additional Enrichment (Guppy + Nanopolish Traditional Workflow)](#additional-enrichment-guppy--nanopolish-traditional-workflow)
    - [SV workflow](#sv-workflow)
    - [DEL workflow](#del-workflow)
    - [INS workflow](#ins-workflow)
    - [ME workflow](#me-workflow)
- [Demo & Usage Examples](#demo--usage-examples)
    - [Folder Overview](#folder-overview)
    - [Example: `DEL/` - Deletion Pipeline](#example-del---deletion-pipeline)
- [Directory Structure](#directory-structure)
- [Release](#release)
    - [v1.1](#v1.1-release-notes)
    - [v1.2](#v1.2-release-notes)
- [Website](#website)
- [License](#license)
- [Citation](#citation)
- [Contact](#contact)

## ChinaMeth profile

<div align="center">
    <img src="images/chinameth.png" alt="chinameth" width="900"/>
</div>

Welcome to **ChinaMeth**, a project dedicated to exploring the complex patterns of DNA methylation across diverse Chinese populations using nanopore sequencing technologies. This repository provides insights into our comprehensive study of methylation dynamics and their role in genetic regulation and environmental adaptation. It also includes scripts for data processing and visulization to facilitate methylation studies.


## Technological advances

<div align="center">
    <img src="images/Advantage.jpg" alt="chinameth" width="900"/>
</div>

- **The largest Chinese cohort methylome collection generated by nanopore sequencing**: Long-read sequencing of native DNA enables genome-methylome co-sequencing, offers high-resolution methylation characterization in repetitive sequences, and enables Mb-scale haplotype phasing.

- **The most comprehensive methylation atlas of the Chinese population**: Representing the second phase of the China 100,000 Genomes Project, the cohort involves 106 individuals across diverse geographical regions encompassing a multitude of environmental gradients.

- **A multidimensional analytical framework for cohort methylome**: This integrated framework allows the unified analysis of segmental, haplotype-specific and population-specific differential methylations. Our study reveals epigenetic associations with genomic structural variants (for the first time), genetic imprints and population adaptations.

## Breakgthrough findings

<div align="center">
    <img src="images/breakthrough.jpg" alt="breakthrough" width="900"/>
</div>

- **An additive epigenetic response to genomic deletions**
We found that genome-wide large deletions are associated with localized, **~2-fold epigenetic compensation** on their undeleted counterpart. We also found that genomic background methylation falls into a linear response region of gene regulation. Both observations suggest a novel, general principle of **cis-acting** epigenetic compensation to maintain gene expression regulation in the presence of DNA fragment loss.

- **Demethylation as a pervasive strategy to generate differential methylation patterns**
Through haplotype- and population-level comparative analysis, we expanded the sets of potential imprinted genes and epigenetically adapted genes by hundreds to thousands. We observed previously less-characterized genomic regions as a hot spot of demethylation for epigenetic adaptability.

- **Altitude-dependent epigenetic dynamics**
Leveraging the altitude gradient data, we established for the first time **quantitative response curves for epigenetic regulation**, which revealed 639 genes subject to strong epigenetic regulation toward high-altitude (HA) adaptation. Further analysis identified core regulators of HA adaptation, whereas certain previously known HA genes were not epigenetically regulated.

## Benefits for Future Researchers
- **Comprehensive ONT Analysis Pipeline**: ChinaMeth offers a complete ONT analysis workflow, including essential scripts for key processing steps, streamlining data analysis for new users and experienced researchers alike.

- **Open Data Access with Interactive Visualization**: The platform provides open access to methylation data with an interactive visualization interface, enabling researchers to explore and interpret methylation patterns across populations with ease.

- **Novel Findings for Reference**: ChinaMeth presents a range of unique insights and findings, providing valuable references and hypotheses for future research in epigenetics and population studies.

## Analysis Workflow
ChinaMeth provides a comprehensive workflow for DNA methylation data analysis. This workflow encompasses essential analysis scripts for processing methylation data, conducting SV-methylation correlation analyses, and generating visualizations.

### Methylation workflow
<div align="center">
    <img src="images/Meth_workflow.png" alt="Methylation workflow" width="500"/>
</div>

The Methylation analysis pipeline includes the following scripts:

1. **methylation_calling.sh**: Performs DNA basecalling, alignment, and methylation calling.
2. **methylation_phasing.sh**: Performs phasing and calculates haplotype-specific methylation frequencies.
3. **hDMR_calculate.sh**: Calculates and filters DMRs and DMCs.

### Additional Enrichment (Guppy + Nanopolish Traditional Workflow)

For users interested in the traditional Guppy + Nanopolish workflow, we provide the following scripts:

- **nanopy.sh**: Executes the traditional Guppy + Nanopolish workflow for basecalling and methylation calling.
- **calculate_methylation_frequency.py**: Computes methylation frequency based on Nanopolish results.

### SV workflow
<div align="center">
    <img src="images/SV_workflow.png" alt="SV worflow" width="400"/>
</div>

**SV Workflow** is a comprehensive workflow designed for analyzing methylation patterns in structural variants (SVs). The workflow consists of the following three main steps:
1. **SV Data Preprocessing**: Integrate individual data into a population-level dataset and perform data filtering and quality control. This step ensures data integrity and reliability for downstream analysis.
2. **SV Methylation Level Analysis**: Perform detailed analysis of methylation patterns in SV regions, with a focus on:
- **DEL Workflow**: Analyze methylation patterns in deletion (DEL) regions to explore their distribution and potential functional roles within the genome.
- **INS Workflow**: Investigate methylation patterns in insertion (INS) regions to uncover changes in methylation levels during the insertion process.
3. **Identifying Transpoable Elements**:Examine changes in methylation patterns of insertion (INS) regions as transposable elements (TEs). Using the **MEG Workflow**, this step explores the mechanisms behind methylation dynamics in TEs and their impact on genome stability.

### DEL workflow
<div align="center">
    <img src="images/del_pipeline.png" alt="DEL Pipeline" width="600"/>
</div>

The DEL analysis pipeline includes the following scripts:

1. **sv_sampleFilter.sh**: Filters and standardizes SV data for individual samples. 
2. **merge_pop.sh**: Merges SV data across populations, then filters and standardizes the merged data. 
3. **DEL_pop.sh**: Calculates sDMR (significant Differentially Methylated Region) methylation levels for DELs within populations. 
4. **DEL_plot.R**: Generates scatter and density plots for DEL methylation levels.

### INS workflow
<div align="center">
    <img src="images/ins_pipeline.png" alt="INS Pipeline" width="700"/>
</div>

The INS analysis pipeline includes the following scripts:

1. **extractReadFromINS.py**: Extracts methylation signals and sequences around INS (Insertion) variants. 
2. **compareSide2kbINS.sh**: Compares methylation levels between INS regions and their upstream/downstream 2kb regions. 
3. **ins_pop_merge.sh**: Merges individual methylation data files into a population-level file. 
4. **INS_plot.R**: Generates scatter and density plots for INS methylation levels.

### ME workflow
<div align="center">
    <img src="images/INS_reAlign2.png" alt="INS reAlign" width="500"/>
</div>

1. **reAlign.py**: Identify the source location of INS (insertion) consensus sequences.
2. **pop_reAlign.py**: Integrate the results into a group format.
3. **extract_fa.sh**: Annotate the INS with source into MEGs.

## Demo & Usage Examples

Each folder in the `scripts/` directory corresponds to a specific pipeline or analysis module. We provide usage demos with input data, expected output, and step-by-step instructions.

### Folder Overview

| Folder | Description | Example Available |
|--------|-------------|-------------------|
| `DEL/` | Pipeline for deletion (DEL) events | ✅ |
| `INS/` | Pipeline for insertion (INS) events | ✅ |
| `MEG/` | Pipeline for mobile element events | ✅ |
| `ONT/` | The process from fast5 signal to final bed methylation file | ✅ |
| `Others/` | Miscellaneous scripts and utilities |❌|   

---

###  Example: `DEL/` - Deletion Pipeline

**1. Description:**

This pipeline identifies methylation signatures around DEL events and summarizes them by sample and region.

**2. Input files:**

The input VCF file should be **structural variation calls that have been force-called** using tools like `cuteSV`, `Sniffles`, `SVIM`, and `NanoVar`.
Example:
    ./Demo/for_DEL/sam.cuteSV_force_calling.genotype.vcf.gz

**3. Run scripts:**

| Step | Script Path | Command | Description | Input | Output |
|------|-------------|---------|-------------|--------|--------|
| 1 | `scripts/DEL/sv_sampleFilter.sh` | `bash ../../scripts/DEL/sv_sampleFilter.sh sam1` | Filter and standardize individual VCF file | `sam1.vcf.gz` | `sam1.Filter.Stand.vcf.gz` |
| 2 | `scripts/DEL/merge_pop.sh` | `bash ../../scripts/DEL/merge_pop.sh inlist.txt 2 pop` | Merge individual VCFs into a population-level VCF | `inlist.txt` (list of VCFs) | `pop1_filtered_DEL_AC2.vcf` |
| 3 | `scripts/DEL/DEL_pop.sh` | `bash ../../scripts/DEL/DEL_pop.sh pop_filtered_DEL_AC2.vcf` | Extract heterozygous deletions (DELs) from population VCF | `invcf.vcf.gz` | `pop.cpg` |
| 4 | `scripts/DEL/DEL_plot.R` | ` ` | Draw scatter plots and density maps of DEL and its flanking regions | `pop.cpg` | ` ` |

**4. Expected output:**
The output cpg files include heterozygous deletions and their surrounding methylation context
Example:
    ./Demo/for_DEL/pop.cpg

## Directory Structure
- `data/`: Contains raw and processed data files
- `scripts/`: Contains scripts for data processing and analysis
    - `DEL/`: Scripts specific to DEL analysis, including sample filtering, population merging, methylation level calculation, and plotting.
    - `INS/`: Scripts specific to INS analysis, including population merging, methylation level calculation, and plotting.
    - `MEG/`: Scripts specific to locate the source of INS and annotate the consensus sequence.    
    - `Others/`: Other statistical analysis scripts.    
- `plots/`: Contains generated plots and visualizations
- `docs/`: Documentation and Usage instructions

## Website
Explore CpG and three types of DMR distributions, including sDMR, hDMR, and pDMR, on our interctive [ChinaMeth](http://bioinformatics.hit.edu.cn/methylation).

## Release

### v1.1 Release Notes

- Added basic project description
- Provided core scripts for structural variation and methylation analysis
- Updated README with usage instructions
- Organized initial workflow structure, including INS, DEL, and ONT modules

## v1.2 Release Notes

- Fixed bug in DEL processing pipeline related to methylation extraction
- Added complete DEL module demo (input data, script, expected output)
- Updated DEL folder structure and usage guide


## License
This project is licensed under the MIT License. See the [LICENSE](LICENSE) file for more details.

## Citation
If you use ChinaMethAtlas in your research, please cite the following paper: **A comprehensive DNA methylation atlas for the Chinese population through nanopore long-read sequencing of 106 individuals**

## Contact
For any questions, please contact [email](yli21b@hit.edu.cn)
